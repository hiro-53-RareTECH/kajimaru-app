# web(django), nginxのコンテナを作成（本番用）
services:
  # Djangoの設定
  web:
    # コンテナ名をdjango_prodに設定
    container_name: django_prod
    # Python(django)のDockerfileをビルド
    # ビルドコンテキストは「カレントディレクトリ」とする
    build:
      context: .
      dockerfile: docker/Dockerfile.prod
      # ビルド時のDockerfileの変数設定
      args:
        UID: ${UID:-1001}
        GID: ${GID:-1001}
        USERNAME: ${USERNAME:-appuser}
        GROUPNAME: ${GROUPNAME:-appgroup}
    # dockerコンテナ起動時のデフォルトコマンド設定
    # RDS MySQLはコンソール操作で常に起動しているため、wait-for-it.shは本番環境では削除（また、KMSからMySQL_HOSTの読み込みが難しいため。）
    command: >
      sh -c "
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3 --max-requests 1000 --max-requests-jitter 100"
    # 内部ネットワークの明示（外には公開せず、nginxからのみアクセス可能）
    expose:
      - "8000"
    # コンテナを削除するまで常に再起動する設定
    restart: always
    # 環境変数の設定
    environment:
      - TZ=${TZ}
    # .envファイルから環境変数を読み込む
    env_file:
      - .env
    volumes:
      - ./staticfiles:/src/staticfiles
    # Djangoのhealthcheckの設定 nginxから/healthへリバースプロキシ
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # nginxの設定
  nginx:
    # コンテナ名をnginxに設定
    container_name: nginx
    build:
      context: .
      dockerfile: infra/nginx/Dockerfile
    depends_on:
      web:
        condition: service_healthy
    ports:
      - "80:80"
    # コンテナを削除するまで常に再起動する設定
    restart: always
    # nginxの設定ファイルをコンテナへバインドマウント
    volumes:
      - ./infra/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./staticfiles:/src/staticfiles:ro
    # nginxのヘルスチェック
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/nginx-health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
