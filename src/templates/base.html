{% load static %}

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}かじまる{% endblock %}</title>
    <!-- favicon -->
    <link rel="icon" href="{% static 'img/kajimaru_favicon.svg' %}">
    <link rel="apple-touch-icon" href="{% static 'img/kajimaru_favicon.svg' %}">
    <!-- Bootstrap CSS -->
    <link 
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" 
      crossorigin="anonymous"
    >
    <link rel="stylesheet" href="{% static 'css/color.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/form.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />



     {% block css %}
     {% endblock %}
</head>
<body>
  <div class="wrapper">
    <header class="header">
        {% block header %}
        {% endblock %}
    </header>
    <main class="main">
        <section class="page-section">
            <h1 class="page-title">
                {% block page_title %}{% endblock %}
            </h1>
            {% block content %}
            {% endblock %}
        </section>
    </main>
    <footer class="footer">
        {% block footer %}
        {% endblock %}
    </footer>

    <!-- Bootstrap JS -->
    <script 
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" 
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" 
      crossorigin="anonymous"
    >
    </script>
    {% block script %}
    {% endblock %}
  </div>
  <dialog id="weather-modal" style="width:min(520px,92%);border:none;border-radius:12px;padding:0;">
    <div style="padding:12px 16px;border-bottom:1px solid #eee;font-weight:600;display:flex;align-items:center;gap:8px">
      <span id="weather-title">今日の東京の天気</span>
      <span id="weather-emoji" aria-hidden="true"></span>
    </div>
    <div id="weather-body" style="padding:16px 18px"></div>
    <div style="padding:0 16px 16px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="document.getElementById('weather-modal').close()">閉じる</button>
    </div>
  </dialog>

  <script>
    (function(){
      const openEls = [
        document.getElementById('weather-open'),
        document.getElementById('weather-open-text')
      ].filter(Boolean);
      const modal = document.getElementById('weather-modal');
      const titleEl = document.getElementById('weather-title');
      const emojiEl = document.getElementById('weather-emoji');
      const bodyEl  = document.getElementById('weather-body');

      async function openWeather(){
        try{
          bodyEl.innerHTML = "取得中…";
          emojiEl.textContent = "";
          // サーバ側APIにfetch
          const res = await fetch("/api/weather/recommendations/");
          const j = await res.json();
          if(!j.ok) throw new Error("failed");

          titleEl.textContent = `今日の東京の天気：${j.label}`;
          emojiEl.textContent = j.emoji;

          const tempPart = (j.temperature !== null && j.temperature !== undefined)
            ? `<div style="color:#666">現在気温：約 ${j.temperature}℃</div>` : "";

          const list = j.tasks.map(t => `<li>${t}</li>`).join("");
          bodyEl.innerHTML = `
            <p style="margin:0 0 6px">${j.one_liner}</p>
            ${tempPart}
            <div style="margin-top:10px">
              <div style="font-weight:600;margin-bottom:6px">おすすめの家事</div>
              <ul style="margin:0 0 8px 18px">${list}</ul>
            </div>
            <small style="color:#999">（東京エリア / Open-Meteo）</small>
          `;
        }catch(e){
          titleEl.textContent = "今日の東京の天気";
          emojiEl.textContent = "❔";
          bodyEl.innerHTML = `<p>天気の取得に失敗しました。時間をおいてお試しください。</p>`;
        }
        modal.showModal();
      }

      openEls.forEach(el => el && el.addEventListener('click', openWeather));
    })();
  </script>

</body>
</html>